import{fieldBox as e,fBoxList as t,fBoxInit as s}from"./m-fieldbox.min.js?v=1718446754";import{iconBox as i}from"../../../lib/assets/js/m-iconbox.min.js?v=1718446754";import{setErrorMessage as a}from"../../../lib/assets/js/m-utils.min.js?v=1718446754";import{elBinder as n,showSpinner as o,popupAlert as d,dialogBox as l,getFormValue as r}from"../../../lib/assets/js/m-general.min.js?v=1718446754";import{adminFlashNotice as c}from"../../../lib/assets/js/m-admin.min.js?v=1718446754";window.fBoxList=t;const p=jQuery,u=new i("iconbox");class h extends n{node;#e=document.querySelector("form");constructor(){super();const e=this;this.node=document.getElementById("rds-form"),this.node.querySelectorAll("[data-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-handle"))})),this.addEventListener("input",(t=>{const s=t.detail.handle;if("post_id"==s&&(e.post_id?(p(".btn-save-page").html("Update"),e.elBinded("slug").readOnly=!0):(p(".btn-save-page").html("Create"),e.elBinded("slug").readOnly=!1)),"type"==s){const s="menu"==t.detail.value;e.elBinded("parent_menu").closest("tr").classList.toggle("hide",s),e.elBinded("menu_title").closest("tr").classList.toggle("hide",!s),e.elBinded("page_icon").closest("tr").classList.toggle("hide",!s)}"page_icon"==s&&(e.elBinded("btn_icon").removeAttribute("class"),e.elBinded("btn_icon").setAttribute("class","button button-secondary dashicons-before "+e.page_icon))})),this.addEventListener("buttonClick",(e=>{"btn_icon"==e.detail.handle&&u.open()})),this.addEventListener("saved",(s=>{e.post_id=s.detail.id,Object.values(t.list).forEach((t=>{e.#t(t)})),e.setLastData()})),this.elBinded("slug").setAttribute("data-valid-handle","page_slug"),this.#s(),s(),this.#e.addEventListener("input",this.#i),p(".btn-save-page").on("click",(()=>{e.saveData()}))}#a;setLastData(){this.#a=r(this.#e)}saveData(){const e=this;if(o(!0),p(".rds-input:visible").each((function(){m(this)})),Object.values(t.list).forEach((e=>{if(!e.node.classList.contains("expanded")){e.node.classList.add("expanded");const t=p(e.node);t.find(".rds-input:visible").each((function(){m(this)})),0==t.find(".rds-error-message:visible").length&&e.node.classList.remove("expanded")}})),0!=p(".rds-error-message:visible").length)return d("Data Validation","Save failed, please check your input!"),void o(!1);const s={title:this.title,slug:this.slug,description:this.description,capability:this.capability,type:this.type,parent:this.parent_menu,menu_title:this.menu_title,icon:this.page_icon,position:this.position,fields:[{type:"form_table",name:this.slug+"_aft",fields:t.getValues()}]},i=wpApiSettings.root+this.#e.getAttribute("data-endpoint")+(this.post_id?"/"+this.post_id:""),a=this.post_id?"put":"post";p.ajax({url:i,method:a,data:JSON.stringify(s),dataType:"json",contentType:"application/json; charset=utf-8",beforeSend:e=>{e.setRequestHeader("X-WP-Nonce",wpApiSettings.nonce)},success:t=>{e.dispatchEvent(new CustomEvent("saved",{detail:{id:t.data.id,json:s}})),o(!1),c("success",t.message)},error:e=>{o(!1),e.hasOwnProperty("responseJSON")&&e.responseJSON.hasOwnProperty("message")?d("Save Failed",e.responseJSON.message):c("error",e.responseText,1e4)}})}fillData(e,t){try{this.post_id=e,this.title=t.title,this.slug=t.slug,this.description=t.description,this.capability=t.capability,this.type=t.type,this.parent_menu=t.parent,this.menu_title=t.menu_title,this.page_icon=t.icon,this.position=t.position,t.fields[0].fields.forEach((e=>{this.#n(e,0)}))}catch(e){console.error(e.message)}}#n(t,s){const i=new e;i.parentID=s,t.options.forEach((e=>{i.addOption(e)})),t.attributes.forEach((e=>{i.addAttribute(e)})),i.type=t.type,i.name=t.name,i.label=t.label,i.description=t.description,i.default_value=t.default_value,i.classes=t.classes,t.fields.forEach((e=>{this.#n(e,i.id)})),this.#t(i)}#t(e){e.elBinded("btn_shortcode").disabled&&(e.elBinded("btn_shortcode").disabled=!1,e.addEventListener("buttonClick",(t=>{"btn_shortcode"==t.detail.handle&&(e=>{const t=new l("dlg-shortcode"),s=(e,t,s)=>{const i=document.createElement("div"),a=document.createElement("div"),n=document.createElement("input"),o=document.createElement("label"),d=document.createElement("button");return o.textContent=t,o.setAttribute("for",e),n.id=e,n.value=s,n.setAttribute("style","width: 320px;"),n.setAttribute("type","text"),n.readOnly=!0,d.setAttribute("class","no-button dashicons dashicons-clipboard"),d.addEventListener("click",(async e=>{n.select(),n.setSelectionRange(0,99999);try{await navigator.clipboard.writeText(n.value)}catch(e){document.execCommand("copy")}c("success","Copied the text: "+n.value)})),a.setAttribute("style","display: flex;align-items: center;column-gap: 4px;"),a.append(n),a.append(d),i.setAttribute("style","display: flex; flex-direction: column; row-gap: 4px; padding: 8px 0;"),i.append(o),i.append(a),i};return t.title="Code for "+e.elBinded("fbox_title").innerHTML+" field",g.slug,e.name,t.appendContent(s("sc","WordPress Shortcode:",`[${g.slug} field=${e.name}]`)),t.appendContent(s("go","PHP:",`get_option("${g.slug}")("${e.name}")`)),t.addButton("Close"),t.addEventListener("buttonClick",(e=>{e.target.close()})),t.addEventListener("close",(t=>{t.target.node.remove(),e.elBinded("btn_shortcode").focus()})),t})(e).open()})))}#s(){const e=this;u.addEventListener("open",(t=>{e.page_icon&&t.target.elBinded(e.page_icon).focus()})),u.addEventListener("close",(t=>{e.elBinded("btn_icon").focus()})),u.addEventListener("iconClick",(t=>{e.page_icon=t.detail.icon,t.target.close()}))}#i(e){m(e.target)}clear(){this.post_id="",this.title="",this.slug="",this.description="",this.capability="manage_options",this.type="menu",this.parent_menu="",this.menu_title="",this.page_icon="dashicons-admin-generic",this.position="",this.slug="",Object.keys(t.list).forEach((e=>{t.remove(e)})),p(".rds-error-message").html("")}show(){p("#rds-form").removeClass("hide"),p(".btn-warpper-header").removeClass("hide"),this.elBinded("title").focus(),this.setLastData()}#o(){const e=new l("dlg-close-page");return e.title="Close Confirmation",e.content="Are you sure that you want to close the current page? The changes that you made won't be saved.",e.addButton(["Yes","No"]),e.addEventListener("buttonClick",(e=>{"Yes"==e.detail.text&&(p("#rds-list").removeClass("hide"),p(".btn-add-page").removeClass("hide"),p("#rds-form").addClass("hide"),p(".btn-warpper-header").addClass("hide")),e.target.close()})),e.addEventListener("close",(e=>{e.target.node.remove()})),e}close(){this.#a!=r(this.#e)?this.#o().open():(p("#rds-list").removeClass("hide"),p(".btn-add-page").removeClass("hide"),p("#rds-form").addClass("hide"),p(".btn-warpper-header").addClass("hide"))}}const m=e=>{a(e);const t=e.getAttribute("data-valid-handle");if("page_slug"==t){let t=/^\w+$/;if(""!=e.value&&!t.test(e.value))return a(e,"This field may only contain letters, numbers, and underscores"),!1}if("field_name"==t){e.setAttribute("data-val",e.value);let s=/^\w+$/;if(""!=e.value&&!s.test(e.value))return a(e,"This field may only contain letters, numbers, and underscores"),!1;const i=document.querySelectorAll('[data-valid-handle="'+t+'"][data-val="'+e.value+'"]');if(i.length>1)return i.forEach((t=>{t.setAttribute("data-duplicate",e.value),a(t,"This field cannot be duplicates")})),!1;{const s=e.getAttribute("data-duplicate");if(s){e.removeAttribute("data-duplicate");const i=document.querySelectorAll('[data-valid-handle="'+t+'"][data-val="'+s+'"]');1==i.length&&i.forEach((e=>{e.removeAttribute("data-duplicate"),a(e)}))}}}e.checkValidity()||a(e,e.validationMessage)},g=new h;export{h as optPage,g as page};