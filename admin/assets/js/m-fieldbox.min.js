import{getCounter as e,dialogBox as t,getHTMLTemplate as s,animateCollapse as d,eventList as i,elBinder as n}from"../../../lib/assets/js/m-general.min.js";import{keydownMoveIcon as o}from"../../../lib/assets/js/m-utils.min.js";const l=jQuery,a=e=>{const t=new r;t.type="text",t.node.classList.add("expanded"),t.parentID=e,t.node.scrollIntoView({behavior:"smooth",block:"start",inline:"start"}),t.elBinded("type").focus()};class r extends n{node;#e={text:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"]},checkbox:{classes:"",fields:["label","name","description","classes","shortcode"]},color:{classes:"",fields:["label","name","description","default_value","classes","shortcode"]},date:{classes:"",fields:["label","name","description","classes","shortcode"]},number:{classes:"small-text",fields:["label","name","description","default_value","classes","shortcode"]},email:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"]},password:{classes:"regular-text",fields:["label","name","description","classes","shortcode"]},phone:{classes:"regular-text",fields:["label","name","description","classes","shortcode"]},radio:{classes:"",fields:["label","name","description","classes","options","shortcode"]},select:{classes:"",fields:["label","name","description","classes","options","shortcode"]},textarea:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"]},url:{classes:"regular-text",fields:["label","name","description","classes","shortcode"]},media:{classes:"",fields:["label","name","description","classes","shortcode"]},editor:{classes:"",fields:["label","name","description","default_value","classes","shortcode"]},container:{classes:"rg-border-t",fields:["label","name","description","classes","fields"]},tabs:{classes:"",fields:["label","name","description","classes","fields"]},tab:{classes:"rd-pt-8",fields:["label","name","description","classes","fields"]}};#t={};#s=new i;#d=new i;#i;#n;get id(){return this.#n}get options(){let e={};if(this.#e[this.type].fields.includes("options"))for(const t of this.node.querySelector(".rds-field-option-list").children)e[t.id]=this.#s.get(t.id);return e}get attributes(){let e={};for(const t of this.node.querySelector(".rds-field-attribute-list").children)e[t.id]=this.#d.get(t.id);return e}get fields(){let e={};if(this.#e[this.type].fields.includes("fields"))for(const t of this.node.querySelector(".rds-field-boxes").children)e[t.id]=h.get(t.id);return e}set parentID(e=0){this.#i=e;let t=null;e&&(t=document.querySelector("#"+e+" > .rds-group-field > .rds-field-boxes")),t||(t=document.querySelector(".rds-fields-content > .rds-field-boxes")),t.appendChild(this.node);const s=h.get(e);s&&(["tabs","tab","container"].includes(s.type)&&(s.elBinded("type").disabled=!0,s.elBinded("type").classList.add("rds-bold")),"tabs"==s.type&&(this.type="tab",this.elBinded("type").disabled=!0,this.elBinded("type").classList.add("rds-bold")));h.dispatchEvent(new CustomEvent("added",{bubbles:!0,detail:{item:this}}))}get parentID(){return this.#i}constructor(){super(),this.#n="fb"+e(),this.#o(),this.node.querySelectorAll("[data-fbox-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-fbox-handle"))})),this.node.querySelectorAll("[data-type-handle]").forEach((e=>{this.#t[e.getAttribute("data-type-handle")]=e})),this.#l(),this.elBinded("name").setAttribute("data-valid-handle","field_name"),h.add(this)}#o(){this.node=s("fieldbox-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[fbid]",this.id)}addOption(e=null){const t=new u(this.id);return e instanceof Object&&(t.default=e.default,t.value=e.value,t.text=e.text),this.#s.add(t),t}addAttribute(e=null){const t=new c(this.id);return e instanceof Object&&(t.name=e.name,t.value=e.value),this.#d.add(t),t}getValues(){const e={type:this.type,name:this.name,label:this.label,description:this.description,default_value:this.default_value,classes:this.classes,options:[],attributes:[],fields:[]};["radio","select"].includes(e.type)&&Object.values(this.options).forEach((t=>{e.options.push({default:t.default,value:t.value,text:t.text})})),Object.values(this.attributes).forEach((t=>{e.attributes.push({name:t.name,value:t.value})}));if(["tabs","tab","container"].includes(e.type))for(const t of this.node.querySelector(".rds-field-boxes").children)e.fields.push(h.get(t.id).getValues());return e}selects(e){return this.node.querySelectorAll(".el-wrapper "+e)}select(e){return this.node.querySelector(".el-wrapper "+e)}remove(){const e=this;d(this.node,100,(function(){!function(){const t=h.get(e.parentID);e.node.querySelectorAll(".rds-field-box"),e.node.querySelectorAll(".rds-field-box").forEach((e=>{h.remove(e.id)})),h.remove(e.id),e.node.remove(),t&&0==t.node.querySelectorAll(".rds-field-boxes .rds-field-box").length&&(t.elBinded("type").removeAttribute("disabled"),t.elBinded("type").classList.remove("rds-bold"))}()}))}dialogRemoveFieldBox(){const e=this,s=new t("dlg-remove-field");return s.title="Delete Confirmation",s.content="Are you sure you want to remove this field?",s.addButton(["Yes","No"]),s.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&e.remove(),t.target.close()})),s.addEventListener("open",(t=>{const s=e.select(".rds-field-box-header .move-handle-icon");s.classList.remove("dashicons-move"),s.classList.add("dashicons-trash"),e.node.classList.add("removing")})),s.addEventListener("close",(t=>{const s=e.select(".rds-field-box-header .move-handle-icon");s.classList.remove("dashicons-trash"),s.classList.add("dashicons-move"),e.node.classList.remove("removing"),e.select("button.remove-field").focus(),t.target.node.remove()})),s}dialogRemoveAttribute(e){const s=this,d=new t("dlg-remove-att");return d.title="Delete Confirmation",d.content="Are you sure you want to remove this attribute?",d.addButton(["Yes","No"]),d.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&s.#a(e),t.target.close()})),d.addEventListener("open",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-move"),s.classList.add("dashicons-trash")})),d.addEventListener("close",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-trash"),s.classList.add("dashicons-move"),e.node.querySelector("button.remove-attr").focus(),t.target.node.remove()})),d}dialogRemoveOption(e){const s=this,d=new t("dlg-remove-opt");return d.title="Delete Confirmation",d.content="Are you sure you want to remove this option?",d.addButton(["Yes","No"]),d.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&s.#r(e),t.target.close()})),d.addEventListener("open",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-move"),s.classList.add("dashicons-trash")})),d.addEventListener("close",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-trash"),s.classList.add("dashicons-move"),e.node.querySelector("button.remove-option").focus(),t.target.node.remove()})),d}#a(e){const t=this;d(e.node,60,(function(){t.#d.remove(e.id),e.node.remove()}))}#r(e){const t=this;d(e.node,60,(function(){t.#s.remove(e.id),e.node.remove()}))}#l(){const e=this;this.addEventListener("input",(t=>{const s=t.detail.handle;if("type"==s){const s=this.elBinded("type"),d=s.options[s.selectedIndex].text;this.node.setAttribute("data-type",this.type),e.fbox_type=d;const i=this.node.querySelector(".rds-group-field > .rds-btn-add-wrapper > button.btn-group-new-field");"tabs"==this.type?(i.textContent="Add New Tab",i.setAttribute("data-add","tab")):(i.textContent="Add New Field",i.setAttribute("data-add","field")),["select","radio"].includes(t.detail.value)&&0==Object.keys(e.options).length&&(e.addOption(),e.addOption()),e.name||(e.classes=e.#e[t.detail.value].classes);let n=!1;Object.keys(e.#t).forEach((function(s){n=!e.#e[t.detail.value].fields.includes(s),e.#t[s].classList.toggle("hide",n)}))}"label"!=s&&"name"!=s||(e.fbox_title=e.label?e.label:e.name)})),this.addEventListener("buttonClick",(t=>{const s=t.detail.handle;if("btn_remove_field"==s){if(!e.label&&!e.name)return void e.remove();e.dialogRemoveFieldBox().open()}if("btn_add_field"==s&&a(e.id),"title_wrapper"!=s&&"btn_expanse_collapse"!=s||e.node.classList.toggle("expanded"),"btn_clear_opt_default"==s&&(e.select(".opt-default input:checked").checked=!1),"btn_generate_id"==s){const t=(e.label?e.label:e.type).toLowerCase().replace(/[\W_]+/g,"_");e.name=t;const s=function(){Object.values(h.list).forEach((function(d){if(d.id!=e.id&&d.name==e.name)return e.name==t?e.name=t+"_1":e.name=t+"_"+(Number(e.name.split("_").pop())+1),void s()}))};s(),e.elBinded("name").setAttribute("data-val",e.name)}})),this.select(".rds-field-box-title .move-handle-icon").addEventListener("keydown",o),this.#c(),this.#u()}#c(){const e=this;this.elBinded("btn_add_attribute").onclick=function(){e.addAttribute().elBinded("name").focus()},this.#d.addEventListener("single",(function(){e.select("table.rds-field-attributes-table").classList.remove("hide"),e.select(".rds-field-attribute-footer").appendChild(e.select("button.btn-add-attribute"))})),this.#d.addEventListener("empty",(function(){e.select("table.rds-field-attributes-table").classList.add("hide"),e.select(".rds-field-attribute-header").appendChild(e.select("button.btn-add-attribute"))})),this.#d.addEventListener("add",(function(t){const s=t.detail.item;s instanceof c?(s.node.querySelector(".remove-attr").onclick=()=>{s.name||s.value?e.dialogRemoveAttribute(s).open():e.#a(s)},s.node.querySelector(".move-handle-icon").addEventListener("keydown",o)):t.preventDefault()}))}#u(){const e=this;this.elBinded("btn_add_option").onclick=()=>{e.addOption().elBinded("value").focus()},this.#s.addEventListener("add",(function(t){const s=t.detail.item;s instanceof u?(s.node.querySelector(".remove-option").onclick=()=>{s.value||s.text?e.dialogRemoveOption(s).open():e.#r(s)},s.node.querySelector(".move-handle-icon").addEventListener("keydown",o)):t.preventDefault()}))}}class c extends n{node;#n;get id(){return this.#n}#h;set fbid(e){this.#h=e}get fbid(){return this.#h}#o(){this.#n="att"+e(),this.node=s("field-attribute-row-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[attid]",this.id)}constructor(e){super(),this.#h=e,this.#o(),this.node.querySelectorAll("[data-att-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-att-handle"))})),document.querySelector("#"+e+" table.rds-field-attributes-table tbody").appendChild(this.node)}}class u extends n{node;#n;get id(){return this.#n}#h;set fbid(e){this.#h=e}get fbid(){return this.#h}#o(){this.#n="opt"+e(),this._bind.default={},this._bind.value={},this._bind.text={},this.node=s("field-option-row-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[optid]",this.id)}constructor(e){super(),this.#h=e,this.#o(),this.node.querySelectorAll("[data-opt-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-opt-handle"))})),document.querySelector("#"+e+" table.rds-field-options-table tbody").appendChild(this.node)}}const h=new i,b=()=>{h.addEventListener("add",(e=>{!e.detail.item instanceof r&&e.preventDefault()})),h.getValues=()=>{const e=[];for(const t of document.querySelector(".rds-field-boxes").children)e.push(h.get(t.id).getValues());return e},l(".rds-field-boxes").sortable({handle:".rds-field-box-title"}),h.addEventListener("empty",(()=>{document.querySelector(".rds-fields-header .rds-fields-title").appendChild(document.querySelector(".btn-new-field"))})),h.addEventListener("single",(()=>{document.querySelector(".rds-btn-add-wrapper.rds-btn-add-footer").appendChild(document.querySelector(".btn-new-field")),document.querySelector(".expand-collapse-wrapper").classList.add("hide")})),h.addEventListener("many",(()=>{document.querySelector(".expand-collapse-wrapper").classList.remove("hide")})),h.addEventListener("added",(e=>{l(e.detail.item.node.querySelector(".rds-field-boxes")).sortable({handle:".rds-field-box-title"}),l(e.detail.item.select("table.rds-field-attributes-table tbody")).sortable({handle:".move-handle"}),l(e.detail.item.select("table.rds-field-options-table tbody")).sortable({handle:".move-handle"})})),document.querySelector("button.btn-new-field").onclick=()=>{a()};const e=e=>{Object.values(h.list).forEach((t=>{t.node.classList.toggle("expanded",e)}))};document.querySelector("button.btn-expand-all").onclick=()=>e(!0),document.querySelector("button.btn-collapse-all").onclick=()=>e(!1)};export{r as fieldBox,h as fBoxList,b as fBoxInit};