import{getCounter as e,dialogBox as t,getHTMLTemplate as s,animateCollapse as i,eventList as d,elBinder as o}from"../../../lib/assets/js/m-general.min.js";import{keydownMoveIcon as n}from"../../../lib/assets/js/m-utils.min.js";const r=jQuery,l={handle:".rds-field-box-title",placeholder:"rds-sortable-placeholder",connectWith:".rds-field-boxes",forceHelperSize:!0,receive:function(e,t){const s=e.target.closest(".rds-field-box"),i=null===s?"root":s.getAttribute("data-type");h.list[t.item[0].id].wrappers.includes(i)||r(t.sender).sortable("cancel")},over:function(e,t){const s=e.target.closest(".rds-field-box"),i=null===s?"root":s.getAttribute("data-type");h.list[t.item[0].id].wrappers.includes(i)?document.querySelector(".rds-sortable-placeholder").classList.toggle("hide",!1):document.querySelector(".rds-sortable-placeholder").classList.toggle("hide",!0)}},a=e=>{const t=e.target,s=t.closest(".rds-field-box"),i=document.querySelectorAll(`.rds-field-box:not([id="${s.id}"] .rds-field-box)`);let d=0;for(let e=0;e<i.length;++e)if(i[e].id==s.id){d=e;break}("ArrowUp"==e.code||"ArrowLeft"==e.code)&&d>0&&(e.preventDefault(),(()=>{let e,t,s,o=0,n=!1,r=d;for(e=h.list[i[d].id],r--;!n&&r>=0;){if(t=h.list[i[r].id],s="root"==t.parentID?"root":h.list[t.parentID].type,t.parentID==e.parentID){o=r,n=!0;break}if(e.wrappers.includes(s)){o=r,n=!0;break}r--}n&&(e.wrappers.includes(t.type)&&t.id!=e.parentID?i[o].querySelector(".rds-field-boxes").append(i[d]):t.parentID==e.parentID||["tabs","tab","container"].includes(t.type)?i[o].parentElement.insertBefore(i[d],i[o]):i[o].parentElement.append(i[d]))})()),("ArrowDown"==e.code||"ArrowRight"==e.code)&&d<i.length&&(e.preventDefault(),(()=>{let e,t,s,o=0,n=!1,r=d;for(e=h.list[i[d].id],r++;!n&&r<i.length;){if(t=h.list[i[r].id],s="root"==t.parentID?"root":h.list[t.parentID].type,"root"!=t.parentID&&e.wrappers.includes(s)){o=r,n=!0;break}if(e.wrappers.includes(t.type)){o=r,n=!0;break}if(!["tabs","tab","container"].includes(t.type)&&e.wrappers.includes(s)){o=r,n=!0;break}r++}if(n)if(e.wrappers.includes(t.type))i[o].querySelector(".rds-field-boxes").prepend(i[d]);else if(e.parentID==t.parentID){const e=i[o].nextSibling;null===e?i[o].parentElement.appendChild(i[d]):e.parentElement.insertBefore(i[d],e)}else i[o].parentElement.insertBefore(i[d],i[o])})()),t.focus()},c=e=>{const t=new p;t.type="text",t.node.classList.add("expanded"),t.parentID=e,t.node.scrollIntoView({behavior:"smooth",block:"start",inline:"start"}),t.elBinded("type").focus()};class p extends o{node;#e={text:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},checkbox:{classes:"",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},color:{classes:"",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},date:{classes:"",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},number:{classes:"small-text",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},email:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},password:{classes:"regular-text",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},phone:{classes:"regular-text",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},radio:{classes:"",fields:["label","name","description","classes","options","shortcode"],wrappers:["root","container","tab"]},select:{classes:"",fields:["label","name","description","classes","options","shortcode"],wrappers:["root","container","tab"]},textarea:{classes:"regular-text",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},url:{classes:"regular-text",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},media:{classes:"",fields:["label","name","description","classes","shortcode"],wrappers:["root","container","tab"]},editor:{classes:"",fields:["label","name","description","default_value","classes","shortcode"],wrappers:["root","container","tab"]},container:{classes:"rg-border-t",fields:["label","name","description","classes","fields"],wrappers:["root","container","tab"]},tabs:{classes:"",fields:["label","name","description","classes","fields"],wrappers:["root","container","tab"]},tab:{classes:"rd-pt-8",fields:["label","name","description","classes","fields"],wrappers:["tabs"]}};#t={};#s=new d;#i=new d;#d;get id(){return this.#d}get options(){let e={};if(this.#e[this.type].fields.includes("options"))for(const t of this.node.querySelector(".rds-field-option-list").children)e[t.id]=this.#s.get(t.id);return e}get attributes(){let e={};for(const t of this.node.querySelector(".rds-field-attribute-list").children)e[t.id]=this.#i.get(t.id);return e}get wrappers(){return this.#e[this.type].wrappers}get fields(){let e={};if(this.#e[this.type].fields.includes("fields"))for(const t of this.node.querySelector(".rds-field-boxes").children)e[t.id]=h.get(t.id);return e}set parentID(e=0){let t=null;e&&(t=document.querySelector("#"+e+" > .rds-group-field > .rds-field-boxes")),t||(t=document.querySelector(".rds-fields-content > .rds-field-boxes")),t.appendChild(this.node);const s=h.get(e);s&&(["tabs","tab","container"].includes(s.type)&&(s.elBinded("type").disabled=!0,s.elBinded("type").classList.add("rds-bold")),"tabs"==s.type&&(this.type="tab",this.elBinded("type").disabled=!0,this.elBinded("type").classList.add("rds-bold")));h.dispatchEvent(new CustomEvent("added",{bubbles:!0,detail:{item:this}}))}get parentID(){const e=this.node.parentElement.closest(".rds-field-box");return null===e?"root":e.id}constructor(){super(),this.#d="fb"+e(),this.#o(),this.node.querySelectorAll("[data-fbox-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-fbox-handle"))})),this.node.querySelectorAll("[data-type-handle]").forEach((e=>{this.#t[e.getAttribute("data-type-handle")]=e})),this.#n(),this.elBinded("name").setAttribute("data-valid-handle","field_name"),h.add(this)}#o(){this.node=s("fieldbox-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[fbid]",this.id)}addOption(e=null){const t=new b(this.id);return e instanceof Object&&(t.default=e.default,t.value=e.value,t.text=e.text),this.#s.add(t),t}addAttribute(e=null){const t=new u(this.id);return e instanceof Object&&(t.name=e.name,t.value=e.value),this.#i.add(t),t}getValues(){const e={type:this.type,name:this.name,label:this.label,description:this.description,default_value:this.default_value,classes:this.classes,options:[],attributes:[],fields:[]};["radio","select"].includes(e.type)&&Object.values(this.options).forEach((t=>{e.options.push({default:t.default,value:t.value,text:t.text})})),Object.values(this.attributes).forEach((t=>{e.attributes.push({name:t.name,value:t.value})}));if(["tabs","tab","container"].includes(e.type))for(const t of this.node.querySelector(".rds-field-boxes").children)e.fields.push(h.get(t.id).getValues());return e}selects(e){return this.node.querySelectorAll(".el-wrapper "+e)}select(e){return this.node.querySelector(".el-wrapper "+e)}remove(){const e=this;i(this.node,100,(function(){!function(){const t=h.get(e.parentID);e.node.querySelectorAll(".rds-field-box"),e.node.querySelectorAll(".rds-field-box").forEach((e=>{h.remove(e.id)})),h.remove(e.id),e.node.remove(),t&&0==t.node.querySelectorAll(".rds-field-boxes .rds-field-box").length&&(t.elBinded("type").removeAttribute("disabled"),t.elBinded("type").classList.remove("rds-bold"))}()}))}dialogRemoveFieldBox(){const e=this,s=new t("dlg-remove-field");return s.title="Delete Confirmation",s.content="Are you sure you want to remove this field?",s.addButton(["Yes","No"]),s.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&e.remove(),t.target.close()})),s.addEventListener("open",(t=>{const s=e.select(".rds-field-box-header .move-handle-icon");s.classList.remove("dashicons-move"),s.classList.add("dashicons-trash"),e.node.classList.add("removing")})),s.addEventListener("close",(t=>{const s=e.select(".rds-field-box-header .move-handle-icon");s.classList.remove("dashicons-trash"),s.classList.add("dashicons-move"),e.node.classList.remove("removing"),e.select("button.remove-field").focus(),t.target.node.remove()})),s}dialogRemoveAttribute(e){const s=this,i=new t("dlg-remove-att");return i.title="Delete Confirmation",i.content="Are you sure you want to remove this attribute?",i.addButton(["Yes","No"]),i.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&s.#r(e),t.target.close()})),i.addEventListener("open",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-move"),s.classList.add("dashicons-trash")})),i.addEventListener("close",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-trash"),s.classList.add("dashicons-move"),e.node.querySelector("button.remove-attr").focus(),t.target.node.remove()})),i}dialogRemoveOption(e){const s=this,i=new t("dlg-remove-opt");return i.title="Delete Confirmation",i.content="Are you sure you want to remove this option?",i.addButton(["Yes","No"]),i.addEventListener("buttonClick",(t=>{"Yes"==t.detail.text&&s.#l(e),t.target.close()})),i.addEventListener("open",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-move"),s.classList.add("dashicons-trash")})),i.addEventListener("close",(t=>{const s=e.node.querySelector(".move-handle-icon");s.classList.remove("dashicons-trash"),s.classList.add("dashicons-move"),e.node.querySelector("button.remove-option").focus(),t.target.node.remove()})),i}#r(e){const t=this;i(e.node,60,(function(){t.#i.remove(e.id),e.node.remove()}))}#l(e){const t=this;i(e.node,60,(function(){t.#s.remove(e.id),e.node.remove()}))}#n(){const e=this;this.addEventListener("input",(t=>{const s=t.detail.handle;if("type"==s){const s=this.elBinded("type"),i=s.options[s.selectedIndex].text;this.node.setAttribute("data-type",this.type),e.fbox_type=i;const d=this.node.querySelector(".rds-group-field > .rds-btn-add-wrapper > button.btn-group-new-field");"tabs"==this.type?(d.textContent="Add New Tab",d.setAttribute("data-add","tab")):(d.textContent="Add New Field",d.setAttribute("data-add","field")),["select","radio"].includes(t.detail.value)&&0==Object.keys(e.options).length&&(e.addOption(),e.addOption()),e.name||(e.classes=e.#e[t.detail.value].classes);let o=!1;Object.keys(e.#t).forEach((function(s){o=!e.#e[t.detail.value].fields.includes(s),e.#t[s].classList.toggle("hide",o)}))}"label"!=s&&"name"!=s||(e.fbox_title=e.label?e.label:e.name)})),this.addEventListener("buttonClick",(t=>{const s=t.detail.handle;if("btn_remove_field"==s){if(!e.label&&!e.name)return void e.remove();e.dialogRemoveFieldBox().open()}if("btn_add_field"==s&&c(e.id),"title_wrapper"!=s&&"btn_expanse_collapse"!=s||e.node.classList.toggle("expanded"),"btn_clear_opt_default"==s&&(e.select(".opt-default input:checked").checked=!1),"btn_generate_id"==s){const t=(e.label?e.label:e.type).toLowerCase().replace(/[\W_]+/g,"_");e.name=t;const s=function(){Object.values(h.list).forEach((function(i){if(i.id!=e.id&&i.name==e.name)return e.name==t?e.name=t+"_1":e.name=t+"_"+(Number(e.name.split("_").pop())+1),void s()}))};s(),e.elBinded("name").setAttribute("data-val",e.name)}})),this.select(".rds-field-box-title .move-handle-icon").addEventListener("keydown",a),this.elBinded("move_handle").addEventListener("focus",(t=>{e.elBinded("title_wrapper").classList.toggle("rg-ml-8",!0),e.node.querySelector(".rds-field-box-header").classList.toggle("rds-moving",!0)})),this.elBinded("move_handle").addEventListener("blur",(t=>{e.elBinded("title_wrapper").classList.toggle("rg-ml-8",!1),e.node.querySelector(".rds-field-box-header").classList.toggle("rds-moving",!1)})),this.#a(),this.#c()}#a(){const e=this;this.elBinded("btn_add_attribute").onclick=function(){e.addAttribute().elBinded("name").focus()},this.#i.addEventListener("single",(function(){e.select("table.rds-field-attributes-table").classList.remove("hide"),e.select(".rds-field-attribute-footer").appendChild(e.select("button.btn-add-attribute"))})),this.#i.addEventListener("empty",(function(){e.select("table.rds-field-attributes-table").classList.add("hide"),e.select(".rds-field-attribute-header").appendChild(e.select("button.btn-add-attribute"))})),this.#i.addEventListener("add",(function(t){const s=t.detail.item;s instanceof u?(s.node.querySelector(".remove-attr").onclick=()=>{s.name||s.value?e.dialogRemoveAttribute(s).open():e.#r(s)},s.node.querySelector(".move-handle-icon").addEventListener("keydown",n)):t.preventDefault()}))}#c(){const e=this;this.elBinded("btn_add_option").onclick=()=>{e.addOption().elBinded("value").focus()},this.#s.addEventListener("add",(function(t){const s=t.detail.item;s instanceof b?(s.node.querySelector(".remove-option").onclick=()=>{s.value||s.text?e.dialogRemoveOption(s).open():e.#l(s)},s.node.querySelector(".move-handle-icon").addEventListener("keydown",n)):t.preventDefault()}))}}class u extends o{node;#d;get id(){return this.#d}#p;set fbid(e){this.#p=e}get fbid(){return this.#p}#o(){this.#d="att"+e(),this.node=s("field-attribute-row-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[attid]",this.id)}constructor(e){super(),this.#p=e,this.#o(),this.node.querySelectorAll("[data-att-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-att-handle"))})),document.querySelector("#"+e+" table.rds-field-attributes-table tbody").appendChild(this.node)}}class b extends o{node;#d;get id(){return this.#d}#p;set fbid(e){this.#p=e}get fbid(){return this.#p}#o(){this.#d="opt"+e(),this._bind.default={},this._bind.value={},this._bind.text={},this.node=s("field-option-row-template"),this.node.id=this.id,this.node.innerHTML=this.node.innerHTML.replaceAll("[optid]",this.id)}constructor(e){super(),this.#p=e,this.#o(),this.node.querySelectorAll("[data-opt-handle]").forEach((e=>{this._bind(e,e.getAttribute("data-opt-handle"))})),document.querySelector("#"+e+" table.rds-field-options-table tbody").appendChild(this.node)}}const h=new d,f=()=>{h.addEventListener("add",(e=>{!e.detail.item instanceof p&&e.preventDefault()})),h.getValues=()=>{const e=[];for(const t of document.querySelector(".rds-field-boxes").children)e.push(h.get(t.id).getValues());return e},r(".rds-field-boxes").sortable(l),h.addEventListener("empty",(()=>{document.querySelector(".rds-fields-header .rds-fields-title").appendChild(document.querySelector(".btn-new-field"))})),h.addEventListener("single",(()=>{document.querySelector(".rds-btn-add-wrapper.rds-btn-add-footer").appendChild(document.querySelector(".btn-new-field")),document.querySelector(".expand-collapse-wrapper").classList.add("hide")})),h.addEventListener("many",(()=>{document.querySelector(".expand-collapse-wrapper").classList.remove("hide")})),h.addEventListener("added",(e=>{r(e.detail.item.node.querySelector(".rds-field-boxes")).sortable(l),r(e.detail.item.select("table.rds-field-attributes-table tbody")).sortable({handle:".move-handle"}),r(e.detail.item.select("table.rds-field-options-table tbody")).sortable({handle:".move-handle"})})),document.querySelector("button.btn-new-field").onclick=()=>{c()};const e=e=>{Object.values(h.list).forEach((t=>{t.node.classList.toggle("expanded",e)}))};document.querySelector("button.btn-expand-all").onclick=()=>e(!0),document.querySelector("button.btn-collapse-all").onclick=()=>e(!1)};export{p as fieldBox,h as fBoxList,f as fBoxInit};